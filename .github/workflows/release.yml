name: 🚀 Release & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (auto, patch, minor, major)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # RELEASE VALIDATION
  # ============================================================================
  validate-release:
    name: 🔍 Validate Release Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      release-type: ${{ steps.check.outputs.release-type }}
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: 📦 Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: 🔍 Check Release Conditions
        id: check
        run: |
          # Check if this is a manual dispatch with dry run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" == "true" ]]; then
            echo "should-release=dry-run" >> $GITHUB_OUTPUT
            echo "release-type=${{ inputs.release_type }}" >> $GITHUB_OUTPUT
            echo "🧪 Dry run mode enabled"
            exit 0
          fi
          
          # Check if there are releasable commits since last release
          if git log $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD --oneline | grep -E '^[a-f0-9]+ (feat|fix|perf|revert|BREAKING CHANGE)'; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "release-type=auto" >> $GITHUB_OUTPUT
            echo "✅ Releasable changes detected"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "release-type=none" >> $GITHUB_OUTPUT
            echo "ℹ️ No releasable changes found"
          fi

      - name: 🔨 Build & Test
        if: steps.check.outputs.should-release != 'false'
        run: |
          npm run build
          npm run test:unit:fast
          npm run lint:check
          npm run type-check
          echo "✅ Pre-release validation completed"

  # ============================================================================
  # SEMANTIC RELEASE
  # ============================================================================
  semantic-release:
    name: 📦 Semantic Release
    runs-on: ubuntu-latest
    needs: validate-release
    if: needs.validate-release.outputs.should-release != 'false'
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: 📦 Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: 🔨 Build Production Assets
        run: |
          npm run build:clean
          npm run build:standalone
          npm run build:templates
          echo "✅ Production build completed"

      - name: 📋 Create Distribution Package
        run: |
          mkdir -p dist
          npm pack --pack-destination=dist
          echo "✅ Distribution package created"

      - name: 📚 Generate Documentation
        run: |
          npm run docs:generate
          echo "✅ Documentation generated"

      - name: 🚀 Semantic Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [[ "${{ needs.validate-release.outputs.should-release }}" == "dry-run" ]]; then
            echo "🧪 Running semantic-release in dry-run mode"
            npm run release:dry
            echo "released=false" >> $GITHUB_OUTPUT
            echo "version=dry-run" >> $GITHUB_OUTPUT
          else
            echo "🚀 Running semantic-release"
            npm run release
            
            # Check if a release was actually created
            if git describe --tags --exact-match HEAD 2>/dev/null; then
              NEW_VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
              echo "released=true" >> $GITHUB_OUTPUT
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "major=$(echo $NEW_VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
              echo "minor=$(echo $NEW_VERSION | cut -d. -f2)" >> $GITHUB_OUTPUT
              echo "patch=$(echo $NEW_VERSION | cut -d. -f3)" >> $GITHUB_OUTPUT
              echo "✅ Released version $NEW_VERSION"
            else
              echo "released=false" >> $GITHUB_OUTPUT
              echo "version=none" >> $GITHUB_OUTPUT
              echo "ℹ️ No release created (no releasable changes)"
            fi
          fi

      - name: 📊 Release Summary
        run: |
          echo "## 🚀 Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Released | ${{ steps.release.outputs.released }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.release.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.release.outputs.released }}" == "true" ]]; then
            echo "🎉 **Successfully released version ${{ steps.release.outputs.version }}!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📦 Package Information" >> $GITHUB_STEP_SUMMARY
            echo "- **NPM Package**: [@dataproc/mcp-server@${{ steps.release.outputs.version }}](https://www.npmjs.com/package/@dataproc/mcp-server/v/${{ steps.release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Release**: [v${{ steps.release.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Installation**: \`npm install @dataproc/mcp-server@${{ steps.release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **No release created** - No releasable changes detected." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # POST-RELEASE VALIDATION
  # ============================================================================
  post-release-validation:
    name: ✅ Post-Release Validation
    runs-on: ubuntu-latest
    needs: semantic-release
    if: needs.semantic-release.outputs.released == 'true'
    timeout-minutes: 10
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: 🔍 Verify NPM Package
        run: |
          echo "🔍 Verifying NPM package publication..."
          
          # Wait for NPM registry propagation
          sleep 30
          
          # Check if package is available
          PACKAGE_VERSION="${{ needs.semantic-release.outputs.version }}"
          if npm view @dataproc/mcp-server@$PACKAGE_VERSION version; then
            echo "✅ Package @dataproc/mcp-server@$PACKAGE_VERSION is available on NPM"
          else
            echo "❌ Package not found on NPM registry"
            exit 1
          fi

      - name: 🧪 Test Package Installation
        run: |
          echo "🧪 Testing package installation..."
          
          # Create temporary directory and test installation
          mkdir -p /tmp/test-install
          cd /tmp/test-install
          npm init -y
          npm install @dataproc/mcp-server@${{ needs.semantic-release.outputs.version }}
          
          # Verify installation
          if [ -f "node_modules/@dataproc/mcp-server/package.json" ]; then
            echo "✅ Package installation successful"
            INSTALLED_VERSION=$(node -p "require('./node_modules/@dataproc/mcp-server/package.json').version")
            echo "📦 Installed version: $INSTALLED_VERSION"
          else
            echo "❌ Package installation failed"
            exit 1
          fi

      - name: 🔗 Verify GitHub Release
        run: |
          echo "🔗 Verifying GitHub release..."
          
          # Check if GitHub release exists
          RELEASE_TAG="v${{ needs.semantic-release.outputs.version }}"
          if gh release view $RELEASE_TAG --repo ${{ github.repository }}; then
            echo "✅ GitHub release $RELEASE_TAG exists"
          else
            echo "❌ GitHub release not found"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # NOTIFICATION & CLEANUP
  # ============================================================================
  notify-success:
    name: 📢 Success Notification
    runs-on: ubuntu-latest
    needs: [semantic-release, post-release-validation]
    if: needs.semantic-release.outputs.released == 'true' && needs.post-release-validation.result == 'success'
    steps:
      - name: 🎉 Success Notification
        run: |
          echo "## 🎉 Release v${{ needs.semantic-release.outputs.version }} Successfully Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 Package Details" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Package**: [@dataproc/mcp-server@${{ needs.semantic-release.outputs.version }}](https://www.npmjs.com/package/@dataproc/mcp-server)" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: [v${{ needs.semantic-release.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.semantic-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Installation**: \`npm install @dataproc/mcp-server@latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          echo "2. Announce the release to the community" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor for any issues or feedback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**The Dataproc MCP Server v${{ needs.semantic-release.outputs.version }} is now live! 🚀**" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: ❌ Failure Notification
    runs-on: ubuntu-latest
    needs: [semantic-release, post-release-validation]
    if: failure()
    steps:
      - name: ❌ Failure Notification
        run: |
          echo "## ❌ Release Process Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release process encountered an error. Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔍 Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the failed job logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify NPM_TOKEN secret is configured" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure semantic-release configuration is correct" >> $GITHUB_STEP_SUMMARY
          echo "4. Check for any blocking issues in the repository" >> $GITHUB_STEP_SUMMARY