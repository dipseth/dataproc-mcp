# Job Output Handling

This document describes the job output handling functionality implemented for the Dataproc MCP server.

## Overview

The system provides efficient handling of Dataproc job outputs with the following features:
- GCS file download and caching
- Multiple output format support (CSV, JSON, text)
- Size-based hybrid caching strategy
- Automatic format detection
- Error handling and retries

## Components

### 1. GCS Service (`src/services/gcs.ts`)
- Downloads files from Google Cloud Storage
- Handles file metadata retrieval
- Implements retry logic and timeout handling
- Detects output formats

### 2. Cache Manager (`src/services/cache-manager.ts`)
- Implements size-based caching strategy
- Manages cache eviction and cleanup
- Tracks cache statistics
- Configurable cache limits and TTL

### 3. Output Parser (`src/services/output-parser.ts`)
- Parses multiple output formats
- Handles CSV, JSON, and text formats
- Supports number parsing
- CSV delimiter customization
- Generates formatted ASCII table output

### 4. Job Output Handler (`src/services/job-output-handler.ts`)
- Coordinates between components
- Manages caching decisions
- Handles errors and retries
- Provides high-level API

## Configuration

Default cache configuration:
```typescript
{
  enabled: true,
  maxFileSize: 52428800, // 50MB per file
  totalSize: 524288000,  // 500MB total
  ttl: 14400,           // 4 hours
  cleanupInterval: 3600 // 1 hour
}
```

## Usage

Basic usage with default options:
```typescript
const results = await getDataprocJobResults({
  projectId: 'your-project',
  region: 'us-central1',
  jobId: 'job-id',
  format: 'csv',
  useCache: true
});
```

With custom options:
```typescript
const results = await getDataprocJobResults({
  projectId: 'your-project',
  region: 'us-central1',
  jobId: 'job-id',
  format: 'json',
  useCache: true,
  parseNumbers: true,
  wait: true,
  waitTimeout: 60000,
  cacheConfig: {
    maxFileSize: 10485760, // 10MB
    ttl: 7200            // 2 hours
  }
});
```

## Testing

Run integration tests:
```bash
npm run test:integration
```

The tests verify:
- Job submission and result retrieval
- Caching functionality
- Size limit enforcement
- Error handling
- Format parsing

## Error Handling

The system handles various error scenarios:
- GCS access issues
- Invalid file formats
- Timeout conditions
- Cache overflow
- Hash validation failures

Each error type has specific handling and retry logic where appropriate.

## Monitoring

Cache statistics available via `getCacheStats()`:
- Hit/miss counts
- Current size usage
- Eviction counts
- Total items in cache

## Implementation Notes

1. The caching strategy is optimized for frequent access to recent job outputs while preventing memory overflow.

2. File format detection uses multiple methods:
   - Content type headers
   - File extensions
   - Content inspection

3. Security considerations:
   - All GCS operations use authorized credentials
   - Hash validation for file integrity
   - Timeout protection for long operations

4. Performance optimization:
   - Streaming downloads for large files
   - Efficient memory usage in parsers
   - Cache size limits per file and total

## Formatted Output Feature

The system now includes a formatted output feature that enhances the readability of tabular data:

### Overview

- Automatically formats tabular data into clean ASCII tables
- Preserves original structured data alongside formatted output
- Works with all output sources (direct URI, local files, directory-based)
- Configurable table styling and formatting

### Usage

To access the formatted output:

```javascript
const results = await getDataprocJobResults({
 projectId: 'your-project',
 region: 'us-central1',
 jobId: 'job-id',
 format: 'text',
 wait: true
});

if (results.parsedOutput && results.parsedOutput.formattedOutput) {
 console.log('Formatted Table Output:');
 console.log(results.parsedOutput.formattedOutput);
}
```

### Example Output

```
┌──────────────┬────────────┬───────────┐
│database_name │ table_name │ row_count │
├──────────────┼────────────┼───────────┤
│ analytics    │ users      │ 1250      │
│ analytics    │ events     │ 15720     │
└──────────────┴────────────┴───────────┘
```

### Implementation

The formatted output is generated by the `formatTablesOutput` method in the `OutputParser` class, which:

1. Takes an array of table objects (with columns and rows)
2. Formats each table into a clean ASCII table using the `table` library
3. Handles multiple tables if present
4. Returns a formatted string representation

For more details, see the [Formatted Output Implementation](./formatted-output-implementation.md) and [Formatted Output User Guide](./formatted-output-user-guide.md) documents.